# Technical Requirements Document: Report Download Feature

## 1. Feature Overview

The Finance Cost Monitoring backend provides **two downloadable report types** from a FastAPI application:

| Report         | Format          | HTTP Method | Endpoint             | Output Filename       |
| -------------- | --------------- | ----------- | -------------------- | --------------------- |
| Cost Summary   | `.docx` (Word)  | `GET`       | `/api/download/docx` | `Analysis.docx`       |
| Cost Breakdown | `.xlsx` (Excel) | `POST`      | `/api/download/xlsx` | `cost_breakdown.xlsx` |

Both endpoints generate documents **in-memory** (no temp files on disk) and return them as binary `Response` objects with the appropriate MIME type and `Content-Disposition: attachment` header, triggering a browser download.

---

## 2. Architecture

```
┌────────────┐      HTTP       ┌─────────────────┐     Builder      ┌────────────────────┐
│  Frontend   │ ──────────────▶│  FastAPI Router  │ ──────────────▶  │  utils_excel_docx  │
│  (Browser)  │  Blob response │  (main.py)       │  bytes return    │  .py               │
└────────────┘ ◀────────────── └─────────────────┘ ◀──────────────── └────────────────────┘
                                       │
                                       │ Data comes from
                                       ▼
                              ┌─────────────────┐
                              │  Analysis Data   │
                              │  (pipeline.py)   │
                              └─────────────────┘
```

---

## 3. Endpoint Specifications

### 3.1 `GET /api/download/docx` — Word Summary

**Purpose:** Generates a simple Word document containing a text-based cost summary.

**Request:**

| Parameter | Location     | Type     | Description                                                  |
| --------- | ------------ | -------- | ------------------------------------------------------------ |
| `parts`   | Query string | `string` | Pre-formatted text/markdown content to embed in the document |

**Example:**

```
GET /api/download/docx?parts=Cost%20summary%20text%20here...
```

**Response:**

- **Content-Type:** `application/vnd.openxmlformats-officedocument.wordprocessingml.document`
- **Content-Disposition:** `attachment; filename="Analysis.docx"`
- **Body:** Binary `.docx` file

**Builder Function — `build_docx_summary(parts_text: str) -> bytes`:**

```python
def build_docx_summary(parts_text: str) -> bytes:
    doc = Document()                        # Create blank Word document
    doc.add_heading("Cost Summary", level=1) # Add H1 heading
    doc.add_paragraph(parts_text)            # Add the text content as a paragraph
    buf = io.BytesIO()
    doc.save(buf)
    return buf.getvalue()                    # Return raw bytes
```

**Key behaviours:**

- Creates a heading "Cost Summary" at level 1
- Inserts the entire `parts` param as a single paragraph
- The `parts` text is typically a markdown-formatted cost summary generated by the `hand_crafted_summary_markdown()` function (see Section 5)
- Returns raw bytes written to an in-memory `BytesIO` buffer

---

### 3.2 `POST /api/download/xlsx` — Excel Cost Breakdown

**Purpose:** Generates a multi-sheet Excel workbook with detailed cost breakdowns per project.

**Request:**

| Field         | Type              | Description                                                                       |
| ------------- | ----------------- | --------------------------------------------------------------------------------- |
| `projects_df` | `list[dict]`      | Array of project-level records (serialized DataFrame rows)                        |
| `projects`    | `dict[str, dict]` | Nested project data keyed by job number, each containing costline trajectory data |

**Example payload:**

```json
{
  "projects_df": [
    {
      "job_no": "2035",
      "description": "Project Alpha",
      "client": "Client A",
      "period1": "january-2025",
      "period2": "february-2025",
      "file1_metric": 150.5,
      "file2_metric": 162.3,
      "difference": 11.8,
      "difference_abs": 11.8
    }
  ],
  "projects": {
    "2035": {
      "project_meta": { "description": "Project Alpha", "client": "Client A" },
      "total_forecast_costs_at_completion": {
        "period1": "january-2025",
        "period2": "february-2025",
        "file1": 150500,
        "file2": 162300,
        "difference": 11800
      },
      "costline_increases_trajectory": [
        {
          "category": "10 - subcontract",
          "file1_metric": 80000,
          "file2_metric": 85000,
          "difference": 5000,
          "subcategories": [
            {
              "category": "Structural",
              "file1_metric": 50000,
              "file2_metric": 53000,
              "difference": 3000,
              "children": [
                {
                  "category": "Steel Works",
                  "file1_metric": 30000,
                  "file2_metric": 32000,
                  "difference": 2000
                }
              ]
            }
          ]
        }
      ]
    }
  }
}
```

**Response:**

- **Content-Type:** `application/vnd.openxmlformats-officedocument.spreadsheetml.sheet`
- **Content-Disposition:** `attachment; filename="cost_breakdown.xlsx"`
- **Body:** Binary `.xlsx` file

**Builder Function — `build_excel_cost_breakdown()`:**

```python
def build_excel_cost_breakdown(
    projects_df: pd.DataFrame,
    projects: Dict[str, Any],
    subcategories_df_fn,   # Function: project dict -> subcategories DataFrame
    main_costtypes_df_fn,  # Function: project dict -> main cost types DataFrame
    children_df_fn         # Function: project dict -> children DataFrame
) -> bytes:
```

**Sheet structure:**

| Sheet Name            | Content                                                           | Sort Order                 |
| --------------------- | ----------------------------------------------------------------- | -------------------------- |
| `Projects`            | All projects summary table, sorted by `difference_abs` descending | Overall summary            |
| `{job_no}_main_types` | Main cost type breakdown for a specific project                   | By `difference` descending |
| `{job_no}_costlines`  | Subcategory breakdown (parent costlines) for a specific project   | By `difference` descending |
| `{job_no}_children`   | Sub-subcategory (children) breakdown for a specific project       | By `difference` descending |

> **Note:** Sheet names are truncated to 31 characters (Excel limit) using `[:31]`.

**Key behaviours:**

- Uses `openpyxl` engine via `pd.ExcelWriter`
- For each project in the `projects` dict, generates up to 3 detail sheets
- Empty DataFrames are skipped (no empty sheets created)
- All data written via `df.to_excel()` with `index=False`

---

## 4. Data Pipeline (Upstream)

The data that feeds into these reports comes from the following pipeline:

### 4.1 Data Flow

```
SQL Server DB
    │
    ▼  query_batch_to_df(db, period)
Raw DataFrame (one per period)
    │
    ▼  combine_projects_rows(df, project_groups, ...)
Grouped/Collapsed DataFrame
    │
    ▼  table_to_nested_json(df, project_no)
Nested JSON {period_label: [{job_no, costLines, children, ...}]}
    │
    ▼  compute_forecast_diff([path1, path2], metric)
Diff Result = {
    "projects": {
        "<job_no>": {
            "project_meta": {...},
            "total_<metric>": {period1, period2, file1, file2, difference},
            "costline_increases_trajectory": [{category, subcategories: [{children}]}]
        }
    }
}
    │
    ▼  projects_to_dataframe(projects, metric)
projects_df (flat DataFrame for Projects sheet)
    │
    ▼  main_costtypes_df(proj) / subcategories_df(proj) / children_df(proj)
Per-project detail DataFrames (for detail sheets)
```

### 4.2 DataFrame Schemas

**`projects_df` columns:**

| Column           | Type    | Description                                             |
| ---------------- | ------- | ------------------------------------------------------- |
| `job_no`         | `str`   | Project/job number                                      |
| `description`    | `str`   | Project description                                     |
| `client`         | `str`   | Client name                                             |
| `period1`        | `str`   | Label for period 1 (e.g. `"january-2025"`)              |
| `period2`        | `str`   | Label for period 2                                      |
| `file1_metric`   | `float` | Metric value at period 1 (in millions, divided by 1000) |
| `file2_metric`   | `float` | Metric value at period 2 (in millions)                  |
| `difference`     | `float` | `file2_metric - file1_metric`                           |
| `difference_abs` | `float` | Absolute value of `difference`                          |

**`main_costtypes_df` columns:**

| Column         | Type    | Description                  |
| -------------- | ------- | ---------------------------- |
| `category`     | `str`   | Main cost type name          |
| `file1_metric` | `float` | Value at period 1 (millions) |
| `file2_metric` | `float` | Value at period 2 (millions) |
| `difference`   | `float` | Change between periods       |

**`subcategories_df` columns:**

| Column           | Type    | Description                  |
| ---------------- | ------- | ---------------------------- |
| `main_cost_type` | `str`   | Parent main cost type        |
| `category`       | `str`   | Subcategory name             |
| `file1_metric`   | `float` | Value at period 1 (millions) |
| `file2_metric`   | `float` | Value at period 2 (millions) |
| `difference`     | `float` | Change between periods       |

**`children_df` columns:**

| Column           | Type    | Description                  |
| ---------------- | ------- | ---------------------------- |
| `main_cost_type` | `str`   | Parent main cost type        |
| `subcategory`    | `str`   | Parent subcategory           |
| `category`       | `str`   | Sub-subcategory name         |
| `file1_metric`   | `float` | Value at period 1 (millions) |
| `file2_metric`   | `float` | Value at period 2 (millions) |
| `difference`     | `float` | Change between periods       |

---

## 5. Summary Markdown Generator

The DOCX report receives its content from `hand_crafted_summary_markdown(projects, metric)`. This function produces a structured markdown string:

**Output structure:**

```markdown
forecast_costs_at_completion Change Summary

## Job 2035 — Project Alpha

**Key numbers (million):**

- **Period 1 (january-2025) total forecast_costs_at_completion:** 150.50
- **Period 2 (february-2025) total forecast_costs_at_completion:** 162.30
- **Change (january-2025 → february-2025):** 11.80 (increase)

### Costline drivers

- **Main cost type: 10 - subcontract** — 80.00 → 85.00 (**5.00 increase**)
  - Subcategory: **Structural** — 50.00 → 53.00 (**3.00 increase**)
    - Sub-sub: Steel Works — 30.00 → 32.00 (**2.00 increase**)

---
```

**Key behaviours:**

- Values are divided by 1000 to convert to millions
- Zero-difference costlines are skipped
- Three-level hierarchy: main cost type → subcategory → children

---

## 6. Frontend Integration Pattern

### 6.1 API Client Functions

```typescript
// DOCX download
export async function downloadDocx(parts: string): Promise<Blob> {
  const { data } = await axios.get(`${API_BASE}/download/docx`, {
    params: { parts },
    responseType: "blob", // Critical: receive binary data as Blob
  });
  return data;
}

// XLSX download
export async function downloadXlsx(payload: any): Promise<Blob> {
  const { data } = await axios.post(`${API_BASE}/download/xlsx`, payload, {
    responseType: "blob", // Critical: receive binary data as Blob
  });
  return data;
}
```

### 6.2 Browser Download Trigger

```typescript
function downloadBlob(blob: Blob, filename: string) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename; // Sets the downloaded file name
  a.click();
  URL.revokeObjectURL(url); // Clean up the object URL
}
```

### 6.3 UI Button Usage

```tsx
{
  /* Download Summary (DOCX) */
}
<Button
  onClick={async () => {
    const blob = await downloadDocx(summaryMarkdownText);
    downloadBlob(blob, "Analysis.docx");
  }}
>
  Download Summary
</Button>;

{
  /* Download Cost Breakdown (XLSX) */
}
<Button
  onClick={async () => {
    const blob = await downloadXlsx({
      projects_df: projectsDataArray,
      projects: projectsObject,
    });
    downloadBlob(blob, "cost_breakdown.xlsx");
  }}
>
  Download Cost Breakdown Report
</Button>;
```

---

## 7. Dependencies

| Package       | Version   | Purpose                                             |
| ------------- | --------- | --------------------------------------------------- |
| `fastapi`     | `0.115.6` | Web framework, routes and `Response` object         |
| `python-docx` | `1.1.2`   | Word document generation                            |
| `openpyxl`    | `3.1.5`   | Excel file generation (engine for `pd.ExcelWriter`) |
| `pandas`      | `2.2.3`   | DataFrame manipulation and `to_excel()`             |
| `uvicorn`     | `0.34.0`  | ASGI server                                         |

**Frontend:**

- `axios` — HTTP client with `responseType: "blob"` support

---

## 8. Implementation Checklist for a New Project

### Backend

- [ ] Install dependencies: `python-docx`, `openpyxl`, `pandas`
- [ ] Create a utility module (e.g. `utils_report.py`) with:
  - [ ] `build_docx_summary(text: str) -> bytes` function
  - [ ] `build_excel_report(df: pd.DataFrame, ...) -> bytes` function
- [ ] Create API endpoints:
  - [ ] `GET /api/download/docx` — accepts text via query param, returns Word file
  - [ ] `POST /api/download/xlsx` — accepts JSON payload, returns Excel file
- [ ] Use `fastapi.responses.Response` with:
  - [ ] Correct MIME types
  - [ ] `Content-Disposition: attachment; filename="<name>"` header
- [ ] Generate files in-memory using `io.BytesIO()` — no temp files needed
- [ ] Add CORS middleware if frontend is on a different origin

### Frontend

- [ ] Create download API functions that set `responseType: "blob"`
- [ ] Implement `downloadBlob()` helper using `URL.createObjectURL()`
- [ ] Wire up UI buttons to call the download functions
- [ ] Handle loading/error states during download

---

## 9. Key Design Decisions & Notes

1. **In-memory generation:** Documents are generated entirely in RAM using `io.BytesIO()`. This avoids filesystem I/O and temp file cleanup, but means very large reports could consume significant memory.

2. **DOCX simplicity:** The Word report is deliberately simple — a single heading and a paragraph. This keeps the code minimal and the content flexible (caller controls the text).

3. **Excel multi-sheet pattern:** The Excel report writes one summary sheet plus up to 3 detail sheets per project. Sheet names include the job number for easy navigation. The `[:31]` truncation handles Excel's 31-character sheet name limit.

4. **Blob transfer pattern:** The frontend must set `responseType: "blob"` on the HTTP request to receive binary data correctly. The `createObjectURL` → `click()` → `revokeObjectURL` pattern is the standard browser download trigger.

5. **Data transformation for display:** All monetary values in the DataFrames are divided by 1000 to convert from raw units to millions before being written to the report.

6. **No authentication:** The current implementation has no auth on these endpoints. For production, add appropriate authentication/authorization middleware.
